<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickReview - åˆ·é¢˜</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>QuickReview åˆ·é¢˜ç³»ç»Ÿ</h1>
            <div class="nav">
                <a href="/">åˆ·é¢˜</a>
                <a href="/banks">é¢˜åº“ç®¡ç†</a>
                <a href="/stats">ç»Ÿè®¡</a>
                <a href="/upload">ä¸Šä¼ é¢˜ç›®</a>
            </div>
        </div>

        <div class="card" style="margin-bottom: 20px; padding: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: 600;">é€‰æ‹©é¢˜åº“ï¼š</label>
            <select id="bank-select" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em;" onchange="onBankChange()">
                <option value="">åŠ è½½ä¸­...</option>
            </select>
        </div>

        <div class="card question-card">
            <div id="loading" class="question-text" style="text-align: center; color: #999;">
                é€‰æ‹©é¢˜åº“åç‚¹å‡»"ä¸‹ä¸€é¢˜"å¼€å§‹åˆ·é¢˜
            </div>

            <div id="question-content" class="hidden">
                <div class="question-text" id="question-text"></div>

                <div id="answer-section" class="answer-section hidden">
                    <h3 style="margin-bottom: 10px;">ç­”æ¡ˆï¼š</h3>
                    <div class="answer-text" id="answer-text"></div>

                    <div id="stats-info" style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 0.9em;">
                        <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: center;">
                            <span style="display: flex; align-items: center; gap: 4px;">ğŸ“Š ç­”é¢˜æ¬¡æ•°: <strong id="total-count">0</strong></span>
                            <span style="display: flex; align-items: center; gap: 4px; color: #48bb78;">âœ“ ç­”å¯¹: <strong id="correct-count">0</strong></span>
                            <span style="display: flex; align-items: center; gap: 4px; color: #f56565;">âœ— ç­”é”™: <strong id="wrong-count">0</strong></span>
                            <span style="display: flex; align-items: center; gap: 4px; color: #667eea;">ğŸ¯ æ­£ç¡®ç‡: <strong id="accuracy-rate">0%</strong></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" id="show-answer-btn" onclick="showAnswer()" disabled>
                    æ˜¾ç¤ºç­”æ¡ˆ
                </button>
                <button class="btn btn-success" id="correct-btn" onclick="recordAnswer(true)" disabled>
                    âœ“ ç­”å¯¹äº†
                </button>
                <button class="btn btn-danger" id="wrong-btn" onclick="recordAnswer(false)" disabled>
                    âœ— ç­”é”™äº†
                </button>
            </div>

            <div class="btn-group" style="margin-top: 10px;">
                <button class="btn btn-primary" id="next-btn" onclick="loadQuestion()" disabled>
                    ä¸‹ä¸€é¢˜
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentQuestion = null;
        let currentBankId = null;

        async function loadBanks() {
            try {
                const response = await fetch('/api/banks/');
                const banks = await response.json();

                const select = document.getElementById('bank-select');
                if (banks.length === 0) {
                    select.innerHTML = '<option value="">æš‚æ— é¢˜åº“ï¼Œè¯·å…ˆåˆ›å»ºé¢˜åº“</option>';
                    return;
                }

                select.innerHTML = '<option value="">-- è¯·é€‰æ‹©é¢˜åº“ --</option>' +
                    banks.map(bank => `<option value="${bank.id}">${bank.name} (${bank.question_count}é¢˜)</option>`).join('');

                // ä»URLå‚æ•°è·å–é¢˜åº“ID
                const urlParams = new URLSearchParams(window.location.search);
                const bankIdFromUrl = urlParams.get('bank_id');
                if (bankIdFromUrl && banks.some(b => b.id == bankIdFromUrl)) {
                    select.value = bankIdFromUrl;
                    onBankChange();
                }
            } catch (error) {
                alert('åŠ è½½é¢˜åº“å¤±è´¥: ' + error.message);
            }
        }

        function onBankChange() {
            const select = document.getElementById('bank-select');
            currentBankId = select.value ? parseInt(select.value) : null;

            // é‡ç½®ç•Œé¢
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('question-content').classList.add('hidden');
            document.getElementById('next-btn').disabled = !currentBankId;

            if (currentBankId) {
                document.getElementById('loading').textContent = 'ç‚¹å‡»"ä¸‹ä¸€é¢˜"å¼€å§‹åˆ·é¢˜';
            } else {
                document.getElementById('loading').textContent = 'é€‰æ‹©é¢˜åº“åç‚¹å‡»"ä¸‹ä¸€é¢˜"å¼€å§‹åˆ·é¢˜';
            }
        }

        async function loadQuestion() {
            if (!currentBankId) {
                alert('è¯·å…ˆé€‰æ‹©é¢˜åº“');
                return;
            }

            try {
                // é‡ç½®ç•Œé¢
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('question-content').classList.add('hidden');
                document.getElementById('answer-section').classList.add('hidden');
                document.getElementById('show-answer-btn').disabled = true;
                document.getElementById('correct-btn').disabled = true;
                document.getElementById('wrong-btn').disabled = true;

                const response = await fetch(`/api/questions/random?bank_id=${currentBankId}`);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'è·å–é¢˜ç›®å¤±è´¥');
                }

                currentQuestion = await response.json();

                // æ˜¾ç¤ºé¢˜ç›®
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('question-content').classList.remove('hidden');
                document.getElementById('question-text').textContent = currentQuestion.question;
                document.getElementById('show-answer-btn').disabled = false;
            } catch (error) {
                document.getElementById('loading').textContent = 'åŠ è½½é¢˜ç›®å¤±è´¥: ' + error.message;
            }
        }

        async function showAnswer() {
            if (!currentQuestion) return;

            try {
                const response = await fetch(`/api/questions/${currentQuestion.id}/answer`);
                if (!response.ok) {
                    throw new Error('è·å–ç­”æ¡ˆå¤±è´¥');
                }

                const data = await response.json();
                document.getElementById('answer-text').textContent = data.answer;

                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                if (data.stats) {
                    document.getElementById('total-count').textContent = data.stats.total_count;
                    document.getElementById('correct-count').textContent = data.stats.correct_count;
                    document.getElementById('wrong-count').textContent = data.stats.wrong_count;
                    document.getElementById('accuracy-rate').textContent =
                        (data.stats.accuracy * 100).toFixed(1) + '%';
                }

                document.getElementById('answer-section').classList.remove('hidden');

                // å¯ç”¨ç­”é¢˜æŒ‰é’®ï¼Œç¦ç”¨æ˜¾ç¤ºç­”æ¡ˆæŒ‰é’®
                document.getElementById('show-answer-btn').disabled = true;
                document.getElementById('correct-btn').disabled = false;
                document.getElementById('wrong-btn').disabled = false;
            } catch (error) {
                alert('åŠ è½½ç­”æ¡ˆå¤±è´¥: ' + error.message);
            }
        }

        async function recordAnswer(isCorrect) {
            if (!currentQuestion) return;

            try {
                const response = await fetch(`/api/questions/${currentQuestion.id}/record`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_correct: isCorrect })
                });

                if (!response.ok) {
                    throw new Error('è®°å½•ç­”é¢˜å¤±è´¥');
                }

                // è‡ªåŠ¨åŠ è½½ä¸‹ä¸€é¢˜
                loadQuestion();
            } catch (error) {
                alert('è®°å½•ç­”é¢˜å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è·å–é¢˜åº“åˆ—è¡¨
        loadBanks();
    </script>
</body>
</html>
